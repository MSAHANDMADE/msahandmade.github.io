<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coșul tău</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--accent:#0f172a;--danger:#ef4444;--ring:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--text);background:var(--bg)}
  .container{max-width:980px;margin:24px auto;padding:0 16px}
  h1{font-size:38px;margin:0 0 16px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 1px 2px rgba(15,23,42,.05);padding:18px}
  /* listă produse */
  .item{display:grid;grid-template-columns:72px 1fr auto;gap:14px;align-items:center;padding:14px;border-bottom:1px solid var(--ring)}
  .item:last-child{border-bottom:0}
  .thumb{width:72px;height:72px;border-radius:12px;object-fit:cover;background:#eee}
  .title{font-weight:700;line-height:1.2;margin-bottom:6px}
  .price{color:var(--muted);font-weight:600}
  .qtyRow{display:flex;align-items:center;gap:10px;margin-top:10px}
  .qty{display:flex;align-items:center;border:1px solid var(--ring);border-radius:12px;overflow:hidden}
  .qty button{width:44px;height:40px;font-size:22px;border:0;background:#f3f4f6;cursor:pointer}
  .qty input{width:54px;height:40px;text-align:center;border:0;font-weight:700;font-size:18px;background:#fff}
  .remove{width:40px;height:40px;border-radius:12px;border:0;background:#fee2e2;color:#b91c1c;font-size:20px;cursor:pointer}
  .lineTotal{font-size:22px;font-weight:800}
  @media (max-width:640px){
    .item{grid-template-columns:60px 1fr;grid-template-areas:
      "img title"
      "img qty"
      "img total"}
    .thumb{grid-area:img}
    .titleWrap{grid-area:title}
    .totalWrap{grid-area:total;justify-self:end}
    .qtyRow{grid-area:qty}
  }
  .grid{display:grid;gap:16px}
  @media (min-width:860px){.grid{grid-template-columns:2fr 1fr}}
  .totals .row{display:flex;justify-content:space-between;margin:8px 0;font-weight:600}
  .totals .row.muted{color:var(--muted);font-weight:500}
  .hint{color:var(--muted);font-size:14px;margin-top:10px}
  /* form */
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:14px;color:var(--muted)}
  input,textarea,select{height:44px;border:1px solid var(--ring);border-radius:12px;padding:0 12px;font-size:16px;outline:none}
  textarea{height:90px;padding:10px 12px;resize:vertical}
  .radioRow{display:flex;gap:16px;align-items:center;margin:6px 0 12px}
  .row2{display:grid;gap:12px}
  @media (min-width:640px){.row2{grid-template-columns:1fr 1fr}}
  .submit{margin-top:14px;height:50px;border:0;border-radius:14px;background:#0f172a;color:#fff;font-weight:800;font-size:18px;cursor:pointer}
  .submit[disabled]{opacity:.6;cursor:not-allowed}
  .empty{padding:14px;border-radius:12px;background:#fff}
</style>
</head>
<body>
<div class="container">
  <h1>Coșul tău</h1>

  <!-- Lista produse -->
  <div class="card" id="cartCard">
    <div id="cart-items"></div>
  </div>

  <div class="grid" style="margin-top:16px">
    <!-- Totals -->
    <div class="card totals">
      <h2 style="margin:0 0 10px">Totaluri</h2>
      <div class="row"><span>Subtotal</span><span id="subtotal">0.00 RON</span></div>
      <div class="row muted"><span>Reducere</span><span id="discount">– 0.00 RON</span></div>
      <div class="row"><span>Livrare</span><span id="shipping">20.00 RON</span></div>
      <div class="row" style="font-size:22px"><span>Total</span><span id="total">20.00 RON</span></div>
      <div class="hint">Reduceri: ≥200 RON –10%, ≥300 RON –15%, ≥400 RON –20%. Livrare gratuită la 300 RON.</div>
    </div>

    <!-- Formular livrare -->
    <div class="card">
      <h3 style="margin:0 0 8px">Detalii pentru livrare</h3>

      <div class="radioRow">
        <label><input type="radio" name="tip" value="PF" checked> Persoană fizică</label>
        <label><input type="radio" name="tip" value="PJ"> Persoană juridică</label>
      </div>

      <form id="orderForm" autocomplete="on">
        <div id="sectPF">
          <div class="row2">
            <div class="field"><label>Nume</label><input id="nume"></div>
            <div class="field"><label>Prenume</label><input id="prenume"></div>
          </div>
        </div>

        <div id="sectPJ" style="display:none">
          <div class="field"><label>Denumire firmă</label><input id="firma"></div>
          <div class="row2">
            <div class="field"><label>CUI</label><input id="cui"></div>
            <div class="field"><label>Nr. Reg. Comerț</label><input id="regcom"></div>
          </div>
        </div>

        <div class="row2">
          <div class="field"><label>Email</label><input id="email" type="email"></div>
          <div class="field"><label>Telefon</label><input id="telefon" inputmode="tel"></div>
        </div>
        <div class="row2">
          <div class="field"><label>Județ</label><input id="judet"></div>
          <div class="field"><label>Oraș</label><input id="oras"></div>
        </div>
        <div class="row2">
          <div class="field"><label>Cod poștal</label><input id="codpostal"></div>
          <div class="field"><label>Adresă completă</label><input id="adresa"></div>
        </div>
        <div class="field"><label>Mențiuni (opțional)</label><textarea id="mentiuni"></textarea></div>

        <button class="submit" id="submitBtn" type="submit">Plasează comanda</button>
      </form>
    </div>
  </div>
</div>

<!-- Dacă ai emailjs/opțiunile deja incluse global, codul de mai jos le folosește automat -->

<script>
  /* === UTIL: citește coșul, indiferent unde e salvat (MSACart/cart) și normalizează === */
  function readCartRaw() {
    const raw = localStorage.getItem('MSACart') || localStorage.getItem('cart') || '[]';
    try { return JSON.parse(raw) || []; } catch(e){ return []; }
  }
  function saveCartRaw(arr){
    const key = localStorage.getItem('MSACart') ? 'MSACart' : (localStorage.getItem('cart') ? 'cart' : 'MSACart');
    localStorage.setItem(key, JSON.stringify(arr));
  }
  function normalizeItem(it){
    return {
      id: it.id || it.sku || it.code || '',
      name: it.name || it.title || it.nume || 'Produs',
      price: Number(it.price ?? it.pret ?? it.unitPrice ?? 0),
      quantity: Number(it.quantity ?? it.qty ?? it.cant ?? 1),
      image: it.image || it.img || it.poza || ''
    };
  }

  const listEl = document.getElementById('cart-items');
  const subtotalEl = document.getElementById('subtotal');
  const discountEl = document.getElementById('discount');
  const shippingEl = document.getElementById('shipping');
  const totalEl = document.getElementById('total');
  const shippingCost = 20;

  function calcDiscount(sub){
    if (sub >= 400) return sub*0.20;
    if (sub >= 300) return sub*0.15;
    if (sub >= 200) return sub*0.10;
    return 0;
  }

  function renderCart(){
    const raw = readCartRaw();
    const cart = raw.map(normalizeItem);

    listEl.innerHTML = '';
    if (cart.length === 0){
      listEl.innerHTML = '<div class="empty">Coșul este gol.</div>';
    }

    let subtotal = 0;
    cart.forEach((it, idx) => {
      const line = it.price * it.quantity;
      subtotal += line;

      const row = document.createElement('div');
      row.className = 'item';

      row.innerHTML = `
        <img class="thumb" src="${it.image}" alt="${it.name}">
        <div class="titleWrap">
          <div class="title">${it.name}</div>
          <div class="price">${it.price.toFixed(2)} RON</div>
          <div class="qtyRow">
            <div class="qty">
              <button type="button" data-act="dec" data-idx="${idx}">−</button>
              <input value="${it.quantity}" readonly>
              <button type="button" data-act="inc" data-idx="${idx}">+</button>
            </div>
            <button class="remove" type="button" title="Șterge" data-act="del" data-idx="${idx}">×</button>
          </div>
        </div>
        <div class="totalWrap">
          <div class="lineTotal">${line.toFixed(2)} RON</div>
        </div>
      `;

      listEl.appendChild(row);
    });

    const discount = calcDiscount(subtotal);
    const ship = (subtotal - discount) >= 300 || subtotal === 0 ? 0 : shippingCost;
    subtotalEl.textContent = `${subtotal.toFixed(2)} RON`;
    discountEl.textContent = `– ${discount.toFixed(2)} RON`;
    shippingEl.textContent = `${ship.toFixed(2)} RON`;
    totalEl.textContent = `${(subtotal - discount + ship).toFixed(2)} RON`;
  }

  // + / − / ștergere
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    const act = btn.dataset.act;
    const idx = Number(btn.dataset.idx);
    const raw = readCartRaw();
    const item = raw[idx]; if (!item) return;

    const getQ = (obj)=> Number(obj.quantity ?? obj.qty ?? obj.cant ?? 1);
    const setQ = (obj,val)=>{
      if ('quantity' in obj) obj.quantity = val;
      else if ('qty' in obj) obj.qty = val;
      else if ('cant' in obj) obj.cant = val;
      else obj.quantity = val;
    };

    if (act==='inc'){ setQ(item, getQ(item)+1); }
    if (act==='dec'){ setQ(item, Math.max(1, getQ(item)-1)); }
    if (act==='del'){ raw.splice(idx,1); }

    saveCartRaw(raw);
    renderCart();
  });

  // PF / PJ toggle
  const sectPF = document.getElementById('sectPF');
  const sectPJ = document.getElementById('sectPJ');
  document.querySelectorAll('input[name="tip"]').forEach(r=>{
    r.addEventListener('change',()=>{
      const pj = r.value==='PJ';
      sectPJ.style.display = pj ? 'block' : 'none';
      sectPF.style.display = pj ? 'none' : 'block';
    });
  });

  // Submit o singură dată + EmailJS (dacă există)
  const form = document.getElementById('orderForm');
  const submitBtn = document.getElementById('submitBtn');
  let sending = false;

  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    if (sending) return;
    sending = true;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Se trimite…';

    const tip = document.querySelector('input[name="tip"]:checked').value;
    const data = {
      tip,
      nume: document.getElementById('nume')?.value || '',
      prenume: document.getElementById('prenume')?.value || '',
      firma: document.getElementById('firma')?.value || '',
      cui: document.getElementById('cui')?.value || '',
      regcom: document.getElementById('regcom')?.value || '',
      email: document.getElementById('email').value,
      telefon: document.getElementById('telefon').value,
      judet: document.getElementById('judet').value,
      oras: document.getElementById('oras').value,
      codpostal: document.getElementById('codpostal').value,
      adresa: document.getElementById('adresa').value,
      mentiuni: document.getElementById('mentiuni').value,
    };

    const cart = readCartRaw().map(normalizeItem);
    const produseHtml = cart.map(p=>`${p.name} — ${p.quantity} × ${p.price.toFixed(2)} RON = ${(p.quantity*p.price).toFixed(2)} RON`).join('<br>');
    const subtotal = cart.reduce((s,p)=>s+p.price*p.quantity,0);
    const reducere = calcDiscount(subtotal);
    const livrare = (subtotal - reducere) >= 300 || subtotal === 0 ? 0 : 20;
    const total = subtotal - reducere + livrare;

    // Dacă există emailjs, trimitem; altfel doar confirmăm local
    if (window.emailjs && typeof emailjs.send === 'function') {
      try {
        // completează cu service/template din EmailJS, dacă ai alte ID-uri
        const serviceId = window.EMAILJS_SERVICE_ID || 'service_ix0zpp7';
        const templateId = window.EMAILJS_TEMPLATE_ORDER || 'template_9yctwor';
        await emailjs.send(serviceId, templateId, {
          to_email: data.email,
          tip: data.tip,
          nume: data.nume, prenume: data.prenume,
          firma: data.firma, cui: data.cui, regcom: data.regcom,
          telefon: data.telefon, judet: data.judet, oras: data.oras,
          codpostal: data.codpostal, adresa: data.adresa,
          mentiuni: data.mentiuni,
          produse: produseHtml,
          subtotal: subtotal.toFixed(2),
          livrare: livrare.toFixed(2),
          total: total.toFixed(2),
          order_id: Math.floor(100000+Math.random()*900000)
        });
        alert('Comanda a fost trimisă. Mulțumim!');
        // goliți coșul după trimitere
        saveCartRaw([]);
        renderCart();
        form.reset();
      } catch(err){
        alert('Nu s-a putut trimite emailul. Comanda a fost salvată local.');
      }
    } else {
      alert('Comanda a fost înregistrată local (EmailJS nu e configurat pe această pagină).');
    }

    sending = false;
    submitBtn.disabled = false;
    submitBtn.textContent = 'Plasează comanda';
  });

  document.addEventListener('DOMContentLoaded', renderCart);
</script>
</body>
</html>
