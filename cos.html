<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coșul tău | MSA Handmade</title>
  <style>
    body { font-family: "Poppins", sans-serif; margin: 0; background: #fafafa; color: #0f172a; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 20px; }

    .cart-item {
      display: flex; flex-wrap: wrap; align-items: center;
      background: #fff; border-radius: 16px; padding: 15px; margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .cart-item img {
      width: 90px; height: 90px; border-radius: 12px; object-fit: cover; margin-right: 15px;
    }
    .cart-item-info { flex: 1; }
    .cart-item-title { font-weight: 600; font-size: 1rem; margin-bottom: 4px; }
    .cart-item-price { color: #64748b; font-size: 0.9rem; margin-bottom: 8px; }

    .qty { display: flex; align-items: center; gap: 8px; }
    .qty button {
      width: 44px; height: 44px; font-size: 28px; font-weight: 600;
      line-height: 1; border-radius: 12px;
      border: 1px solid #e5e7eb; background:#fff; color:#0f172a; cursor:pointer;
    }
    .qty input {
      width: 64px; height: 44px; text-align:center; font-size:18px; font-weight:600;
      border:1px solid #e5e7eb; border-radius:12px; background:#fff; color:#0f172a;
    }
    .item-total { font-weight: 600; font-size: 1rem; margin-left: auto; }

    .cart-summary {
      background: #fff; padding: 20px; border-radius: 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .cart-summary h2 { font-size: 1.2rem; margin-bottom: 10px; }
    .summary-row {
      display: flex; justify-content: space-between;
      margin: 6px 0; font-size: 0.95rem;
    }
    .summary-row strong { font-weight: 600; }

    form { margin-top: 25px; display: grid; gap: 12px; }
    input, select, textarea {
      width: 100%; padding: 10px 14px; border-radius: 10px;
      border: 1px solid #e5e7eb; font-size: 1rem;
    }

    button[type="submit"] {
      padding: 14px; font-size: 1rem; font-weight: 600;
      color: white; background: #0f172a;
      border: none; border-radius: 10px; cursor: pointer;
    }

    .hidden { display: none; }

    @media (max-width: 480px) {
      .cart-item { flex-direction: column; align-items: flex-start; }
      .item-total { margin-top: 10px; margin-left: 0; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Coșul tău</h1>
    <div id="cart-items"></div>

    <div class="cart-summary">
      <h2>Totaluri</h2>
      <div class="summary-row"><span>Subtotal</span><span id="subtotal">0.00 RON</span></div>
      <div class="summary-row"><span>Livrare</span><span id="shipping">20.00 RON</span></div>
      <div class="summary-row"><strong>Total</strong><strong id="total">0.00 RON</strong></div>
    </div>

    <form id="checkout-form">
      <select id="tip" name="tip" required>
        <option value="persoana fizica">Persoană fizică</option>
        <option value="persoana juridica">Persoană juridică</option>
      </select>

      <div id="pj-fields" class="hidden">
        <input type="text" id="firma" name="firma" placeholder="Denumire firmă" />
        <input type="text" id="cui" name="cui" placeholder="CUI" />
        <input type="text" id="reg" name="reg" placeholder="Nr. Reg. Com." />
      </div>

      <input type="text" id="nume" name="nume" placeholder="Nume" required />
      <input type="text" id="prenume" name="prenume" placeholder="Prenume" required />
      <input type="email" id="email" name="email" placeholder="Email" required />
      <input type="tel" id="telefon" name="telefon" placeholder="Telefon" required />
      <input type="text" id="judet" name="judet" placeholder="Județ" required />
      <input type="text" id="oras" name="oras" placeholder="Oraș" required />
      <input type="text" id="codpostal" name="codpostal" placeholder="Cod poștal" required />
      <textarea id="adresa" name="adresa" placeholder="Adresă completă" required></textarea>
      <textarea id="mentiuni" name="mentiuni" placeholder="Mențiuni pentru curier (opțional)"></textarea>

      <button type="submit" id="submit-btn">Plasează comanda</button>
    </form>
  </div>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    window.EMAILJS_SERVICE = 'service_ix0zpp7';
    window.EMAILJS_TEMPLATE = 'template_13qpqtt';
    window.EMAILJS_PUBLICKEY = 'YOUR_PUBLIC_KEY_HERE'; // pune cheia publică exactă din EmailJS
    emailjs.init(window.EMAILJS_PUBLICKEY);
  </script>

  <script>
    const cartItemsContainer = document.getElementById("cart-items");
    const subtotalEl = document.getElementById("subtotal");
    const totalEl = document.getElementById("total");
    const shippingCost = 20;

    function loadCart() {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      cartItemsContainer.innerHTML = "";
      let subtotal = 0;

      cart.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;

        const div = document.createElement("div");
        div.classList.add("cart-item");
        div.innerHTML = `
          <img src="${item.image}" alt="${item.name}">
          <div class="cart-item-info">
            <div class="cart-item-title">${item.name}</div>
            <div class="cart-item-price">${item.price.toFixed(2)} RON</div>
            <div class="qty">
              <button onclick="changeQty(${index}, -1)">-</button>
              <input type="number" value="${item.quantity}" min="1" readonly>
              <button onclick="changeQty(${index}, 1)">+</button>
            </div>
          </div>
          <div class="item-total">${itemTotal.toFixed(2)} RON</div>
        `;
        cartItemsContainer.appendChild(div);
      });

      subtotalEl.textContent = `${subtotal.toFixed(2)} RON`;
      totalEl.textContent = `${(subtotal + shippingCost).toFixed(2)} RON`;
    }

    function changeQty(index, delta) {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      cart[index].quantity = Math.max(1, cart[index].quantity + delta);
      localStorage.setItem("cart", JSON.stringify(cart));
      loadCart();
    }

    document.getElementById("tip").addEventListener("change", (e) => {
      document.getElementById("pj-fields").classList.toggle("hidden", e.target.value !== "persoana juridica");
    });

    document.getElementById("checkout-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const submitBtn = document.getElementById("submit-btn");
      submitBtn.disabled = true;
      submitBtn.textContent = "Se trimite...";

      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      if (!cart.length) {
        alert("Coșul este gol!");
        submitBtn.disabled = false;
        submitBtn.textContent = "Plasează comanda";
        return;
      }

      const produseHTML = cart.map(p =>
        `${p.name} — ${p.quantity} x ${p.price} RON = ${(p.quantity*p.price).toFixed(2)} RON`
      ).join("<br>");

      const form = e.target;
      const data = {
        tip: form.tip.value,
        firma: form.firma?.value || "-",
        cui: form.cui?.value || "-",
        reg: form.reg?.value || "-",
        nume: form.nume.value,
        prenume: form.prenume.value,
        email: form.email.value,
        telefon: form.telefon.value,
        judet: form.judet.value,
        oras: form.oras.value,
        codpostal: form.codpostal.value,
        adresa: form.adresa.value,
        mentiuni: form.mentiuni.value || "-",
        subtotal: parseFloat(subtotalEl.textContent),
        livrare: shippingCost,
        total: parseFloat(totalEl.textContent),
        produse: produseHTML,
        to_email: form.email.value
      };

      emailjs.send(window.EMAILJS_SERVICE, window.EMAILJS_TEMPLATE, data)
      .then(() => {
        alert("Comanda a fost trimisă cu succes!");
        localStorage.removeItem("cart");
        form.reset();
        loadCart();
      })
      .catch(err => {
        alert("Eroare la trimitere. Verifică EmailJS.");
        console.error(err);
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = "Plasează comanda";
      });
    });

    loadCart();
  </script><script>
  // === AJUTOR: ia coșul indiferent cum a fost salvat (MSACart / cart) ===
  function getNormalizedCart() {
    const raw = localStorage.getItem('MSACart') || localStorage.getItem('cart') || '[]';
    let arr = [];
    try { arr = JSON.parse(raw) || []; } catch(e) { arr = []; }

    // normalizează câmpurile pentru randare
    return arr.map(it => ({
      name:   it.name || it.title || it.nume || 'Produs',
      price:  Number(it.price ?? it.pret ?? it.unitPrice ?? 0),
      quantity: Number(it.quantity ?? it.qty ?? it.cant ?? 1),
      image:  it.image || it.img || it.poza || '',
      id:     it.id || it.sku || it.code || ''
    }));
  }

  const cartItemsContainer = document.getElementById('cart-items');
  const subtotalEl = document.getElementById('subtotal');
  const totalEl = document.getElementById('total');
  const shippingCost = 20;

  function renderCart() {
    const cart = getNormalizedCart();
    if (!cartItemsContainer) return;

    cartItemsContainer.innerHTML = '';
    let subtotal = 0;

    if (cart.length === 0) {
      cartItemsContainer.innerHTML = `<div style="padding:14px;border-radius:12px;background:#fff">
        Coșul este gol.</div>`;
    }

    cart.forEach((item, idx) => {
      const line = item.price * item.quantity;
      subtotal += line;

      const row = document.createElement('div');
      row.className = 'cart-item';
      row.innerHTML = `
        <img src="${item.image}" alt="${item.name}">
        <div class="cart-item-info">
          <div class="cart-item-title">${item.name}</div>
          <div class="cart-item-price">${item.price.toFixed(2)} RON</div>
          <div class="qty">
            <button type="button" data-delta="-1" data-idx="${idx}">−</button>
            <input type="number" value="${item.quantity}" min="1" readonly>
            <button type="button" data-delta="1" data-idx="${idx}">+</button>
          </div>
        </div>
        <div class="item-total">${line.toFixed(2)} RON</div>
      `;
      cartItemsContainer.appendChild(row);
    });

    subtotalEl && (subtotalEl.textContent = `${subtotal.toFixed(2)} RON`);
    totalEl && (totalEl.textContent = `${(subtotal + shippingCost).toFixed(2)} RON`);
  }

  // butoanele +/-
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-delta]');
    if (!btn) return;
    const delta = Number(btn.dataset.delta);
    const idx = Number(btn.dataset.idx);

    // actualizează în cheia existentă (prioritate MSACart)
    const key = localStorage.getItem('MSACart') ? 'MSACart' : 'cart';
    let cart = [];
    try { cart = JSON.parse(localStorage.getItem(key)) || []; } catch(e) { cart = []; }

    const item = cart[idx];
    if (!item) return;
    const curr = Number(item.quantity ?? item.qty ?? item.cant ?? 1);
    const next = Math.max(1, curr + delta);
    if ('quantity' in item) item.quantity = next;
    else if ('qty' in item) item.qty = next;
    else if ('cant' in item) item.cant = next;
    else item.quantity = next;

    localStorage.setItem(key, JSON.stringify(cart));
    renderCart();
  });

  document.addEventListener('DOMContentLoaded', renderCart);
</script>
</body>
</html>
