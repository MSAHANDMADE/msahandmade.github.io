<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MSA Handmade — Coș</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <nav class="nav">
      <a href="index.html">Acasă</a>
      <a href="produse.html">Produse</a>
      <a href="contact.html">Contact</a>
      <a href="cos.html" class="cart" aria-current="page">🛒 <span id="cart-count">0</span></a>
    </nav>
  </header>

  <main class="cart-wrap">
    <div class="cart-head">
      <div>
        <h2>Coșul tău</h2>
        <p style="margin:6px 0 0">
          <a href="produse.html" style="text-decoration:none;font-weight:700">← Înapoi la produse</a>
        </p>
      </div>
      <div class="totals" id="totals" style="display:none">
        <div>Subtotal: <span id="t-sub">0</span> RON</div>
        <div>Livrare: <span id="t-ship">17</span> RON</div>
        <div>Total: <span id="t-total">0</span> RON</div>
      </div>
    </div>

    <div id="cart-empty" style="display:none;color:#6b7280;margin:14px 0">Coșul este gol.</div>
    <div id="cart-list"></div>

    <section class="checkout" id="checkout-box" style="display:none">
      <div class="radio-set" role="radiogroup" aria-label="Tip client">
        <label class="radio-pill"><input type="radio" name="tip" value="Persoană fizică" checked> Persoană fizică</label>
        <label class="radio-pill"><input type="radio" name="tip" value="Persoană juridică"> Persoană juridică</label>
      </div>

      <form id="order-form" class="form-grid">
        <div class="field"><label>Nume</label><input name="nume" required></div>
        <div class="field"><label>Prenume</label><input name="prenume" required></div>
        <div class="field"><label>Email</label><input type="email" name="email" required></div>
        <div class="field"><label>Telefon</label><input name="telefon" required></div>
        <div class="field"><label>Județ</label><input name="judet" required></div>
        <div class="field"><label>Oraș</label><input name="oras" required></div>
        <div class="field"><label>Cod poștal</label><input name="codpostal" required></div>
        <div class="field"><label>Adresă</label><input name="adresa" required></div>
        <div class="field" style="grid-column:1/-1"><label>Mențiuni (opțional)</label><textarea name="mentiuni" rows="3"></textarea></div>

        <div style="grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap">
          <button type="button" id="clear-cart" class="btn-secondary">Golește coșul</button>
          <button type="submit" class="btn" id="place-order">Plasează comanda</button>
        </div>
      </form>

      <div id="order-status" class="status info"></div>
    </section>
  </main>

  <footer class="footer">
    <small>&copy; <span id="year"></span> — MSA Handmade.</small>
  </footer>

  <!-- EmailJS înainte de cart.js -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="script.js"></script>
  <script src="cart.js"></script>

  <script>
    function renderCart() {
      const api = window.MSACart;
      if (!api) return;

      const list = document.getElementById("cart-list");
      const empty = document.getElementById("cart-empty");
      const totals = document.getElementById("totals");
      const box = document.getElementById("checkout-box");
      const form = document.getElementById("order-form");
      const status = document.getElementById("order-status");

      const cart = api.readCart();
      list.innerHTML = "";

      if (!cart.length) {
        empty.style.display = "block";
        totals.style.display = "none";
        box.style.display = "none";
        return;
      }

      empty.style.display = "none";
      totals.style.display = "flex";
      box.style.display = "block";

      cart.forEach(it => {
        const row = document.createElement("div");
        row.className = "cart-row";
        row.innerHTML = `
          <img src="${it.image}" alt="${it.name}">
          <div>
            <div style="font-weight:800">${it.name}</div>
            <div class="qty">
              <button type="button" class="qty-btn" data-act="minus" data-id="${it.id}">–</button>
              <input class="qty-input" type="number" min="0" step="1" value="${it.qty}" data-id="${it.id}">
              <button type="button" class="qty-btn" data-act="plus" data-id="${it.id}">+</button>
            </div>
          </div>
          <div style="font-weight:700">${it.price} RON</div>
          <button class="btn-danger" data-del="${it.id}">Șterge</button>
        `;
        list.appendChild(row);
      });

      const { subtotal, shipping, total } = api.computeTotals(cart);
      document.getElementById("t-sub").textContent = subtotal;
      document.getElementById("t-ship").textContent = shipping;
      document.getElementById("t-total").textContent = total;

      list.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick = ()=>{ api.removeFromCart(b.dataset.del); renderCart(); };
      });
      list.querySelectorAll(".qty-btn").forEach(b=>{
        b.onclick = ()=>{
          const id = b.dataset.id;
          b.dataset.act==="plus" ? api.increaseQty(id) : api.decreaseQty(id);
          renderCart();
        };
      });
      list.querySelectorAll(".qty-input").forEach(inp=>{
        inp.onchange = ()=>{ api.setQty(inp.dataset.id, inp.value); renderCart(); };
      });

      document.getElementById("clear-cart").onclick = ()=>{ api.clearCart(); renderCart(); };

      form.onsubmit = async (e)=>{
        e.preventDefault();
        status.className = "status info";
        status.textContent = "Se trimite comanda…";
        try{
          await api.submitOrder(new FormData(form));
          status.className = "status ok";
          status.textContent = "Comanda a fost trimisă cu succes!";
          setTimeout(()=>{ location.href="multumesc.html"; }, 900);
        }catch(err){
          status.className = "status err";
          status.textContent = "Eroare la trimitere: " + (err?.text || err?.message || "verifică EmailJS");
          console.error(err);
        }
      };
    }
    document.addEventListener("DOMContentLoaded", renderCart);
  </script>
</body>
</html>
