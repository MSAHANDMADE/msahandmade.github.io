<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coșul tău — M.S.A Handmade Decor</title>
<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--bg:#fafafa;--card:#fff}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:32px;margin:12px 0}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 2px 10px rgba(2,6,23,.06)}
  .inner{padding:16px}
  .muted{color:var(--muted)}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #0f172a;background:#0f172a;color:#fff;font-weight:700;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--ink);border-color:var(--line)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}

  /* item: imagine stânga; sub titlu — cantitate + total */
  .item{display:grid;grid-template-columns:72px 1fr;gap:14px;padding:14px;border-bottom:1px solid var(--line);align-items:start}
  .thumb{width:72px;height:72px;object-fit:cover;border-radius:12px;background:#eef2f7}
  .title{font-weight:800;line-height:1.2;margin:0}
  .unit{font-size:12px;color:var(--muted);margin-top:4px}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .qty{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:10px;overflow:hidden;min-width:150px}
  .qty button{width:40px;height:38px;border:0;background:#f8fafc;font-size:20px;cursor:pointer}
  .qty input{width:56px;height:38px;border:0;text-align:center;font-weight:700}
  .remove{width:40px;height:38px;border:0;border-radius:10px;background:#fee2e2;color:#991b1b;font-size:20px;margin-left:8px;cursor:pointer}
  .lineTotal{font-weight:800;font-size:18px;white-space:nowrap}
  @media (max-width:640px){.meta{flex-direction:column;align-items:flex-start;gap:8px}}

  .row{display:flex;justify-content:space-between;margin:8px 0}
  .hint{color:var(--muted);font-size:14px}

  form input, form textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  form textarea{resize:vertical}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .full{grid-column:1/-1}
  @media (max-width:700px){.form-grid{grid-template-columns:1fr}}
  .switch{display:flex;gap:18px;margin:8px 0 12px}
  .submit{width:100%;height:50px;border:0;border-radius:12px;background:#0f172a;color:#fff;font-weight:800;font-size:18px;cursor:pointer}
  .submit[disabled]{opacity:.6;cursor:not-allowed}

  .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .badge{background:#0f172a;color:#fff;padding:2px 8px;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1>Coșul tău <span class="badge" data-cart-count>0</span></h1>
    <a href="produse.html" class="btn ghost">← Înapoi la produse</a>
  </div>

  <div class="grid">
    <!-- STÂNGA: produse -->
    <div class="card">
      <div class="inner" id="cart-list"></div>
      <div class="inner" style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="clear-cart" class="btn ghost">Golește coșul</button>
        <a href="produse.html" class="btn ghost">Continuă cumpărăturile</a>
      </div>
    </div>

    <!-- DREAPTA: total + formular -->
    <div class="card">
      <div class="inner">
        <h2 style="margin:0 0 8px">Totaluri</h2>
        <div class="row"><span>Subtotal</span><strong id="subval">0.00 RON</strong></div>
        <div class="row"><span>Reducere</span><strong id="discval">− 0.00 RON</strong></div>
        <div class="row"><span>Livrare</span><strong id="shipval">20.00 RON</strong></div>
        <div class="row" style="font-size:18px"><span>Total</span><strong id="totval">20.00 RON</strong></div>
        <p class="hint">Reduceri: ≥200 RON −10%, ≥300 RON −15%, ≥400 RON −20%. Livrare gratuită la 300 RON.</p>

        <hr style="margin:14px 0;border:none;border-top:1px solid var(--line)" />

        <h3 style="margin:0 0 6px">Detalii pentru livrare</h3>
        <div class="switch">
          <label><input type="radio" name="tip" value="pf" checked> Persoană fizică</label>
          <label><input type="radio" name="tip" value="pj"> Persoană juridică</label>
        </div>

        <form id="order-form">
          <!-- PF -->
          <div class="pf-only form-grid">
            <input name="nume" placeholder="Nume" required>
            <input name="prenume" placeholder="Prenume" required>
          </div>
          <!-- PJ -->
          <div class="pj-only form-grid" style="display:none">
            <input name="firma" placeholder="Denumire firmă" class="full">
            <input name="cui" placeholder="CUI">
            <input name="reg" placeholder="Nr. Reg. Comerț" class="full">
          </div>

          <div class="form-grid" style="margin-top:10px">
            <input name="email" type="email" placeholder="Email" required>
            <input name="telefon" placeholder="Telefon" required>
            <input name="judet" placeholder="Județ" required>
            <input name="oras" placeholder="Oraș" required>
            <input name="adresa" placeholder="Adresă completă" required class="full">
            <input name="codpostal" placeholder="Cod poștal">
            <textarea name="mentiuni" rows="2" placeholder="Mențiuni (opțional)" class="full"></textarea>
          </div>

          <button id="submitBtn" type="submit" class="submit">Plasează comanda</button>
        </form>
        <p class="hint" style="margin-top:10px">Întrebări? <a href="mailto:msahandmade.contact@gmail.com">msahandmade.contact@gmail.com</a></p>
      </div>
    </div>
  </div>

  <p class="muted" style="text-align:center;margin:22px 0 6px">© <span id="year"></span> — M.S.A Handmade. Toate drepturile rezervate.</p>
</div>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
/* ===== Config EmailJS ===== */
const EMAILJS_PUBLIC_KEY = 'iSadfb7-TV_89l_6k';
const EMAILJS_SERVICE_ID = 'service_ix0zpp7';
const EMAILJS_TEMPLATE_ADMIN  = 'template_13qpqtt';
const EMAILJS_TEMPLATE_CLIENT = 'template_9yctwor';
try{ emailjs.init(EMAILJS_PUBLIC_KEY); }catch(_){}

/* ===== DOAR localStorage (MSA_CART) ===== */
const LS_KEY = 'MSA_CART';

function readCart(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(_){ return []; }
}
function writeCart(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr||[]));
}
function setQty(id, qty){
  const c = readCart().map(p => String(p.id)===String(id) ? {...p, qty:qty} : p);
  writeCart(c);
}
function removeItem(id){
  writeCart(readCart().filter(p=> String(p.id)!==String(id)));
}
function clearCart(){ writeCart([]); }
function money(n){ return (Number(n)||0).toFixed(2)+' RON'; }
function totals(cart){
  const subtotal = cart.reduce((s,p)=> s + (Number(p.price)||0)*(Number(p.qty)||1), 0);
  const discount = subtotal>=400? subtotal*0.20 : subtotal>=300? subtotal*0.15 : subtotal>=200? subtotal*0.10 : 0;
  const shipping = (subtotal - discount) >= 300 || subtotal===0 ? 0 : 20;
  const total = subtotal - discount + shipping;
  return {subtotal, discount, shipping, total};
}

/* ===== Render ===== */
const list  = document.getElementById('cart-list');
const subEl = document.getElementById('subval');
const disEl = document.getElementById('discval');
const shpEl = document.getElementById('shipval');
const totEl = document.getElementById('totval');

function render(){
  const cart = readCart();
  list.innerHTML = '';
  if (!cart.length){
    list.innerHTML = '<div class="muted">Coșul este gol.</div>';
  }else{
    cart.forEach(p=>{
      const q = Number(p.qty)||1;
      const el = document.createElement('div');
      el.className = 'item';
      el.dataset.id = p.id;
      el.innerHTML = `
        <img class="thumb" src="${p.image||''}" alt="${p.name||''}">
        <div>
          <p class="title">${p.name||'Produs'}</p>
          <div class="unit">${money(p.price)}</div>
          <div class="meta">
            <div>
              <div class="qty">
                <button class="dec">−</button>
                <input class="qval" value="${q}" readonly>
                <button class="inc">+</button>
              </div>
              <button class="remove">×</button>
            </div>
            <div class="lineTotal">${money((Number(p.price)||0)*q)}</div>
          </div>
        </div>`;
      list.appendChild(el);
    });
  }
  const t = totals(cart);
  subEl.textContent = money(t.subtotal);
  disEl.textContent = '− ' + money(t.discount);
  shpEl.textContent = money(t.shipping);
  totEl.textContent = money(t.total);

  const badge = document.querySelector('[data-cart-count]');
  if (badge) badge.textContent = cart.reduce((s,p)=> s + (Number(p.qty)||1), 0);
}

/* ===== Actions ===== */
list.addEventListener('click', (e)=>{
  const row = e.target.closest('.item'); if (!row) return;
  const id = row.dataset.id;
  const cart = readCart();
  const i = cart.findIndex(x=> String(x.id)===String(id));
  if (i<0) return;
  const q = Number(cart[i].qty)||1;
  if (e.target.closest('.inc')) { setQty(id, q+1); render(); }
  if (e.target.closest('.dec')) { setQty(id, Math.max(1,q-1)); render(); }
  if (e.target.closest('.remove')){ removeItem(id); render(); }
});
document.getElementById('clear-cart').addEventListener('click', e=>{ e.preventDefault(); clearCart(); render(); });

/* ===== PF / PJ ===== */
function syncPFJ(){
  const tip = (document.querySelector('input[name="tip"]:checked')||{}).value || 'pf';
  const isPJ = tip==='pj';
  document.querySelector('.pj-only').style.display = isPJ ? '' : 'none';
  document.querySelector('.pf-only').style.display = isPJ ? 'none' : '';
  ['firma','cui','reg'].forEach(n=>{ const el=document.querySelector(`[name="${n}"]`); if(el) el.required=isPJ; });
  ['nume','prenume'].forEach(n=>{ const el=document.querySelector(`[name="${n}"]`); if(el) el.required=!isPJ; });
}
document.querySelectorAll('input[name="tip"]').forEach(r=> r.addEventListener('change', syncPFJ));

/* ===== Proforma ===== */
function buildProformaHTML(orderId, cart, t, fd){
  const rows = cart.map(p=>{
    const q = Number(p.qty)||1;
    return `<tr>
      <td style="padding:8px;border-bottom:1px solid #eee">${p.name}</td>
      <td style="padding:8px;border-bottom:1px solid #eee;text-align:center">${q}</td>
      <td style="padding:8px;border-bottom:1px solid #eee;text-align:right">${(Number(p.price)||0).toFixed(2)} RON</td>
      <td style="padding:8px;border-bottom:1px solid #eee;text-align:right">${(q*(Number(p.price)||0)).toFixed(2)} RON</td>
    </tr>`;
  }).join('');
  return `
    <h3 style="font-family:system-ui;margin:0 0 8px">Proformă #${orderId}</h3>
    <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;font-family:system-ui">
      <thead><tr style="background:#f8fafc">
        <th align="left"  style="padding:8px;border-bottom:1px solid #ddd">Produs</th>
        <th align="center"style="padding:8px;border-bottom:1px solid #ddd">Cant.</th>
        <th align="right" style="padding:8px;border-bottom:1px solid #ddd">Preț</th>
        <th align="right" style="padding:8px;border-bottom:1px solid #ddd">Total</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div style="text-align:right;margin-top:10px;font-family:system-ui">
      <div>Subtotal: <b>${t.subtotal.toFixed(2)} RON</b></div>
      <div>Reducere: <b>− ${t.discount.toFixed(2)} RON</b></div>
      <div>Livrare:  <b>${t.shipping.toFixed(2)} RON</b></div>
      <div style="font-size:18px">TOTAL: <b>${t.total.toFixed(2)} RON</b></div>
    </div>
    <div style="color:#64748b;margin-top:8px;font-family:system-ui">Proforma nu este document fiscal.</div>
  `;
}

/* ===== EmailJS Submit ===== */
const orderForm = document.getElementById('order-form');
const submitBtn = document.getElementById('submitBtn');
let sending = false;

orderForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (sending) return;

  const cart = readCart();
  if (!cart.length){ alert('Coșul este gol.'); return; }

  const fd = Object.fromEntries(new FormData(orderForm).entries());
  const t = totals(cart);
  const orderId = Date.now().toString().slice(-6);

  const produseText = cart.map(p => `• ${p.name} × ${(Number(p.qty)||1)} — ${(((Number(p.price)||0))*(Number(p.qty)||1)).toFixed(2)} RON`).join('\n');
  const proformaHTML = buildProformaHTML(orderId, cart, t, fd);

  const adminParams = {
    tip: (fd.tip==='pj'?'Persoană juridică':'Persoană fizică'),
    nume: fd.nume||'-', prenume: fd.prenume||'-',
    email: fd.email||'-', telefon: fd.telefon||'-',
    judet: fd.judet||'-', oras: fd.oras||'-', adresa: fd.adresa||'-',
    codpostal: fd.codpostal||'-', mentiuni: fd.mentiuni||'-',
    produse: produseText,
    subtotal: t.subtotal.toFixed(2),
    livrare: t.shipping.toFixed(2),
    total: t.total.toFixed(2),
    order_id: orderId
  };

  const clientParams = {
    to_email: fd.email,
    nume: (fd.tip==='pj' ? (fd.firma||'Client') : (fd.nume||'Client')),
    order_id: orderId,
    html_proforma: proformaHTML
  };

  sending = true;
  submitBtn.disabled = true;
  submitBtn.textContent = 'Se trimite…';

  try{
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ADMIN, adminParams);
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_CLIENT, clientParams);
    clearCart();
    render();
    alert('✅ Comanda a fost trimisă! Verifică emailul.');
    window.location.href = 'multumesc.html';
  }catch(err){
    console.error(err);
    alert('A apărut o eroare la trimiterea emailului.');
  }finally{
    sending = false;
    submitBtn.disabled = false;
    submitBtn.textContent = 'Plasează comanda';
  }
});

/* ===== Init ===== */
document.getElementById('year').textContent = new Date().getFullYear();
document.addEventListener('DOMContentLoaded', ()=>{ render(); syncPFJ(); });
window.addEventListener('storage', (ev)=>{ if (ev.key===LS_KEY) render(); });
</script>
</body>
</html>
