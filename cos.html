<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coșul tău</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="site-header">
    <a class="brand" href="index.html"><img src="logo.png" alt="MSA Handmade Decor" class="brand-logo" /></a>
    <nav class="nav-links">
      <a href="index.html">Acasă</a>
      <a href="produse.html">Produse</a>
      <a href="contact.html">Contact</a>
      <a href="cos.html" class="cart-link">Coș (<span id="cart-count">0</span>)</a>
    </nav>
  </header>

  <main class="container">
    <h1 class="page-title">Coșul tău</h1>

    <!-- aici se randează conținutul coșului -->
    <div id="cart-root"></div>

    <h2>Date livrare (plata la livrare)</h2>

    <!-- Formularul către FormSubmit -->
    <form id="order-form" class="order-form"
          action="https://formsubmit.co/msahandmade.contact@gmail.com"
          method="POST">

      <!-- Setări FormSubmit -->
      <input type="hidden" name="_next" value="https://msahandmade.ro/multumesc.html" />
      <input type="hidden" name="_subject" value="Comandă nouă - M.S.A Handmade Decor" />
      <input type="hidden" name="_template" value="table" />
      <input type="hidden" name="_captcha" value="false" />

      <!-- Auto-reply către client (mesajul din e-mailul de confirmare) -->
      <input type="hidden" name="_autoresponse"
             value="Mulțumim pentru comandă! Am primit solicitarea ta și revenim în scurt timp cu confirmarea. — M.S.A Handmade Decor" />

      <!-- CC: completăm dinamic cu e-mailul clientului din JS -->
      <input type="hidden" name="_cc" id="order_cc" value="" />
      <!-- Reply-To: setăm din JS cu e-mailul clientului -->
      <input type="hidden" name="_replyto" id="order_replyto" value="" />

      <!-- aici JS va pune rezumatul comenzii (produse + total + date livrare) -->
      <textarea id="order_message" name="message" hidden></textarea>

      <div class="radio-group">
        <label><input type="radio" name="tip" value="pf" checked> Persoană fizică</label>
        <label><input type="radio" name="tip" value="pj"> Persoană juridică</label>
      </div>

      <div class="form-row">
        <label>Nume
          <input type="text" name="nume" required>
        </label>
        <label>Prenume
          <input type="text" name="prenume" required>
        </label>
      </div>

      <div class="form-row">
        <label>Email
          <input type="email" name="email" required>
        </label>
        <label>Telefon
          <input type="tel" name="telefon" required>
        </label>
      </div>

      <div class="form-row">
        <label>Județ
          <input type="text" name="judet" required>
        </label>
        <label>Oraș
          <input type="text" name="oras" required>
        </label>
      </div>

      <div class="form-row">
        <label>Cod poștal
          <input type="text" name="codpostal" required>
        </label>
        <label>Adresă
          <input type="text" name="adresa" required>
        </label>
      </div>

      <!-- Câmpuri extra pentru Persoană juridică -->
      <div class="form-row" id="pj-fields">
        <label>Denumire firmă
          <input type="text" name="firma">
        </label>
        <label>CUI
          <input type="text" name="cui">
        </label>
      </div>

      <div class="form-row">
        <label>Mențiuni (opțional)
          <textarea name="mentiuni" rows="3"></textarea>
        </label>
      </div>

      <div class="form-row">
        <button type="submit" class="btn-primary">Trimite comanda</button>
        <button type="button" class="btn-ghost" onclick="clearCart()">Golește coșul</button>
      </div>
    </form>
  </main>

  <script src="cart.js"></script>
  <script>
    // arată/ascunde câmpurile pentru PJ
    document.querySelectorAll('input[name="tip"]').forEach(r => {
      r.addEventListener('change', () => {
        const pj = document.querySelector('input[name="tip"][value="pj"]').checked;
        document.getElementById('pj-fields').style.display = pj ? 'flex' : 'none';
      });
    });
    document.getElementById('pj-fields').style.display =
      document.querySelector('input[name="tip"][value="pj"]').checked ? 'flex' : 'none';

    // Înainte de trimitere: punem în textarea rezumatul comenzii + setăm CC & Reply-To
    document.getElementById('order-form').addEventListener('submit', function (e) {
      // dacă vrei să vezi local ce se trimite, lasă preventDefault, altfel comentează următoarea linie
      // e.preventDefault();

      const form = e.target;
      const cart = (function () {
        try { return JSON.parse(localStorage.getItem('msa_cart_v1')) || []; } catch { return []; }
      })();

      if (!cart.length) {
        alert('Coșul este gol.');
        e.preventDefault();
        return false;
      }

      const nume = form.nume.value.trim();
      const prenume = form.prenume.value.trim();
      const email = form.email.value.trim();
      const telefon = form.telefon.value.trim();
      const judet = form.judet.value.trim();
      const oras = form.oras.value.trim();
      const codpostal = form.codpostal.value.trim();
      const adresa = form.adresa.value.trim();
      const tip = form.tip.value; // pf / pj
      const firma = form.firma.value.trim() || '';
      const cui = form.cui.value.trim() || '';
      const mentiuni = form.mentiuni.value.trim();

      // validare minimă
      if (!nume || !prenume || !email || !telefon || !judet || !oras || !codpostal || !adresa) {
        alert('Te rog completează toate câmpurile obligatorii.');
        e.preventDefault();
        return false;
      }

      // calcule
      const subtotal = cart.reduce((s, p) => s + p.price * (p.qty || 1), 0);
      const shipping = 17;
      const total = subtotal + shipping;

      const itemsText = cart
        .map(p => `${p.name} × ${p.qty || 1} — ${p.price} RON`)
        .join('%0A');

      // mesajul care ajunge în mail
      const body =
`Tip client: ${tip === 'pj' ? 'Persoană juridică' : 'Persoană fizică'}
${tip === 'pj' ? `Firmă: ${firma}\nCUI: ${cui}\n` : ''}Nume: ${nume} ${prenume}
Email: ${email}
Telefon: ${telefon}
Adresă: ${adresa}, ${oras}, ${judet}, ${codpostal}

Produse:
${decodeURIComponent(itemsText)}

Subtotal: ${subtotal} RON
Livrare: ${shipping} RON
TOTAL: ${total} RON

Mențiuni: ${mentiuni || '—'}`;

      document.getElementById('order_message').value = body;

      // clientul primește CC + reply-to ca să poată răspunde
      document.getElementById('order_cc').value = email;
      document.getElementById('order_replyto').value = email;

      // coșul se golește la pagina de mulțumire (multumesc.html)
    });
  </script>
</body>
</html>
