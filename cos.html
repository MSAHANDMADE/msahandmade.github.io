<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comandă M.S.A Handmade</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>(function(){ emailjs.init('iSadfb7-TV_89l_6k'); })();</script>

  <script src="cart.js"></script>
</head>
<body>
  <header class="site-header">
    <a href="index.html">Acasă</a>
    <a href="produse.html">Produse</a>
    <a href="contact.html">Contact</a>
    <a href="cos.html">Coș (<span id="cart-count">0</span>)</a>
  </header>

  <h1>Finalizează comanda</h1>

  <div class="section">
    <h2>Coșul tău</h2>
    <div id="cart-root"></div>
    <div class="totals">
      <p>Subtotal: <strong><span id="subtotal">0</span> RON</strong></p>
      <p>Livrare: <strong><span id="livrare">0</span> RON</strong></p>
      <p>Total: <strong><span id="total">0</span> RON</strong></p>
    </div>
    <p class="notice">Comenzile se procesează în <strong>1–3 zile lucrătoare</strong>, apoi livrăm prin curier.</p>
  </div>

  <div class="section">
    <h2>Date pentru livrare</h2>
    <form id="orderForm">
      <label for="tip">Tip client</label>
      <select id="tip" name="tip" required>
        <option value="pf" selected>Persoană fizică</option>
        <option value="pj">Persoană juridică</option>
      </select>

      <div class="row">
        <div>
          <label for="nume">Nume</label>
          <input id="nume" name="nume" required>
        </div>
        <div>
          <label for="prenume">Prenume</label>
          <input id="prenume" name="prenume" required>
        </div>
      </div>

      <div id="pj-fields" style="display:none">
        <div class="row">
          <div>
            <label for="firma">Denumire firmă</label>
            <input id="firma" name="firma">
          </div>
          <div>
            <label for="cui">CUI</label>
            <input id="cui" name="cui">
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" name="email" required>
        </div>
        <div>
          <label for="telefon">Telefon</label>
          <input id="telefon" name="telefon" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="judet">Județ</label>
          <input id="judet" name="judet" required>
        </div>
        <div>
          <label for="oras">Oraș</label>
          <input id="oras" name="oras" required>
        </div>
      </div>

      <label for="adresa">Adresă</label>
      <textarea id="adresa" name="adresa" required></textarea>

      <label for="mentiuni">Mențiuni (opțional)</label>
      <textarea id="mentiuni" name="mentiuni" placeholder="Interval livrare, preferințe, etc."></textarea>

      <!-- rezumat pentru e-mail (se umple automat) -->
      <textarea id="order_summary" name="order_summary" hidden></textarea>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button type="submit" class="btn">Trimite comanda</button>
        <a href="produse.html" class="btn secondary">Continuă cumpărăturile</a>
      </div>

      <p id="status" class="notice" style="display:none;margin-top:10px"></p>
    </form>
  </div>

  <script>
    // câmpuri PJ on/off
    document.getElementById('tip').addEventListener('change', e=>{
      document.getElementById('pj-fields').style.display = (e.target.value==='pj') ? 'block' : 'none';
    });
    document.addEventListener('DOMContentLoaded', renderCart);

    // submit: trimite 2 mailuri și redirecționează
    document.getElementById('orderForm').addEventListener('submit', async function(e){
      e.preventDefault();

      const cart = getCart();
      if(cart.length===0){ alert('Coșul este gol.'); return; }

      const statusEl = document.getElementById('status');
      statusEl.style.display = 'block';
      statusEl.textContent = 'Trimiterea comenzii...';

      const orderId = Math.floor(Math.random()*900000 + 100000);

      const params = {
        tip: document.getElementById('tip').value === 'pj' ? 'Persoană juridică' : 'Persoană fizică',
        nume: document.getElementById('nume').value.trim(),
        prenume: document.getElementById('prenume').value.trim(),
        email: document.getElementById('email').value.trim(),
        telefon: document.getElementById('telefon').value.trim(),
        judet: document.getElementById('judet').value.trim(),
        oras: document.getElementById('oras').value.trim(),
        adresa: document.getElementById('adresa').value.trim(),
        mentiuni: document.getElementById('mentiuni').value.trim() || '-',
        firma: document.getElementById('firma') ? (document.getElementById('firma').value.trim() || '-') : '-',
        cui: document.getElementById('cui') ? (document.getElementById('cui').value.trim() || '-') : '-',
        produse: document.getElementById('order_summary').value,
        order_id: orderId,
        subtotal: document.getElementById('subtotal').textContent,
        livrare: document.getElementById('livrare').textContent,
        total: document.getElementById('total').textContent
      };

      try{
        // către TINE (Contact Us)
        await emailjs.send('service_ix0zpp7','template_13qpqtt',params);
        // către CLIENT (Order Confirmation)
        await emailjs.send('service_ix0zpp7','template_9yctwor',params);

        clearCart();
        window.location.href = 'multumesc.html';
      }catch(err){
        console.error(err);
        statusEl.textContent = 'A apărut o eroare la trimitere. Te rugăm încearcă din nou.';
        alert('Eroare la trimiterea comenzii.');
      }
    });
  </script>
</body>
</html>
