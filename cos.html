<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CoÈ™ â€” MSA Handmade</title>

  <!-- SEO / OG -->
  <meta name="description" content="FinalizeazÄƒ comanda pentru lumÃ¢nÄƒri È™i decoraÈ›iuni MSA Handmade. Livrare gratuitÄƒ de la 300 RON." />
  <link rel="canonical" href="https://www.msahandmade.ro/cos.html" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.msahandmade.ro/cos.html" />
  <meta property="og:title" content="CoÈ™ â€” MSA Handmade" />
  <meta property="og:description" content="CoÈ™ul tÄƒu MSA Handmade. Vezi produsele È™i plaseazÄƒ comanda." />
  <meta property="og:image" content="https://www.msahandmade.ro/images/logo.png" />

  <link rel="stylesheet" href="styles.css" />
  <style>
    .wrap{max-width:980px;margin:0 auto;padding:0 16px}
    #main-nav{display:flex;justify-content:center;gap:15px;flex-wrap:nowrap}
    #main-nav a{text-decoration:none;color:#333;font-weight:500;padding:6px 10px}
    #main-nav a:hover{color:#d12b4a}
    .cart-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f7f7f7}

    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:960px){.grid{grid-template-columns:2fr 1fr}}

    table.cart{width:100%;border-collapse:collapse}
    table.cart th, table.cart td{padding:10px;border-bottom:1px solid #eee;vertical-align:middle}
    table.cart img{width:72px;height:72px;object-fit:cover;border-radius:8px}
    .qty{display:inline-flex;border:1px solid #ddd;border-radius:8px;overflow:hidden}
    .qty button{width:34px;height:34px;border:0;background:#f6f6f6}
    .qty input{width:42px;text-align:center;border:0}

    .totals{display:grid;gap:8px}
    .totals .row{display:flex;justify-content:space-between}
    .totals .big{font-size:1.15rem;font-weight:700}

    form .row{display:flex;flex-direction:column;margin-bottom:10px}
    input, textarea{border:1px solid #ddd;border-radius:10px;padding:10px}
    button.primary{width:100%;padding:12px;border:0;border-radius:10px;background:#0a2230;color:#fff;font-weight:700}
    .muted{color:#777;font-size:.9rem}

    .promo{padding:8px;text-align:center;background:#0a2230;color:#fff}
    footer{text-align:center;padding:20px 10px;font-size:14px;color:#666;border-top:1px solid #ddd;background:#fafafa}
    footer .legal-nav a{margin:0 5px;color:#555;text-decoration:none}
    footer .legal-nav a:hover{color:#d12b4a}
  </style>
</head>
<body>
  <div class="promo">
    <b>Reduceri pÃ¢nÄƒ la -20%</b> Â· <b>Livrare gratuitÄƒ</b> de la <b>300 RON</b>
  </div>

  <header class="header">
    <nav id="main-nav">
      <a href="index.html">AcasÄƒ</a>
      <a href="produse.html">Produse</a>
      <a href="despre.html">Despre</a>
      <a href="contact.html">Contact</a>
      <a href="cos.html" class="cart-pill" aria-label="Vezi coÈ™ul">ðŸ›’ <span id="cart-count">0</span></a>
    </nav>
  </header>

  <main class="wrap">
    <h1>CoÈ™ul tÄƒu</h1>

    <section class="grid">
      <!-- CoÈ™ -->
      <article class="card">
        <table class="cart" id="cart-table" aria-live="polite">
          <thead>
            <tr>
              <th>Produs</th>
              <th>Pret</th>
              <th style="width:120px">Cant.</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="cart-body"><tr><td colspan="5">Se Ã®ncarcÄƒâ€¦</td></tr></tbody>
        </table>
        <p class="muted">* Imaginile sunt cu titlu de prezentare. Produsele sunt realizate manual â€” pot exista mici variaÈ›ii.</p>
      </article>

      <!-- Rezumat + Formular -->
      <aside class="card">
        <div class="totals" id="totals">
          <div class="row"><span>Subtotal</span><b id="t-sub">0 RON</b></div>
          <div class="row"><span>Reducere</span><b id="t-disc">0 RON</b></div>
          <div class="row"><span>Livrare</span><b id="t-ship">calculat</b></div>
          <div class="row big"><span>Total</span><b id="t-total">0 RON</b></div>
          <div class="muted">Livrare gratuitÄƒ pentru comenzi de la 300 RON.</div>
        </div>

        <hr style="margin:14px 0; border:0; border-top:1px solid #eee" />

        <form id="checkout-form" autocomplete="on">
          <div class="row">
            <label>Nume È™i prenume</label>
            <input name="nume" required />
          </div>
          <div class="row">
            <label>Email</label>
            <input name="email" type="email" required />
          </div>
          <div class="row">
            <label>Telefon</label>
            <input name="telefon" inputmode="tel" required />
          </div>
          <div class="row">
            <label>AdresÄƒ livrare</label>
            <textarea name="adresa" rows="3" required></textarea>
          </div>
          <div class="row">
            <label>ObservaÈ›ii</label>
            <textarea name="observatii" rows="3" placeholder="Culoare, mesaj, interval orar, etc."></textarea>
          </div>

          <button id="btn-confirm" class="primary" type="submit">ConfirmÄƒ comanda</button>
        </form>
      </aside>
    </section>
  </main>

  <footer>
    <small>&copy; <span id="year"></span> â€“ MSA Handmade. Toate drepturile rezervate.</small>
    <nav class="legal-nav">
      <a href="termeni.html">Termeni & CondiÈ›ii</a> Â·
      <a href="confidentialitate.html">ConfidenÈ›ialitate</a> Â·
      <a href="cookies.html">Cookies</a> Â·
      <a href="retur.html">Retur</a>
    </nav>
  </footer>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    // pune aici cheia ta publicÄƒ:
    // emailjs.init('PUBLIC_KEY');
  </script>

  <!-- CoÈ™ + Checkout logic -->
  <script>
    // ---------- Helpers coÈ™ (foloseÈ™te MSACart dacÄƒ existÄƒ, altfel localStorage) ----------
    function _readCartFallback() {
      try { return JSON.parse(localStorage.getItem('msa_cart')||'[]'); } catch(e){ return []; }
    }
    function _writeCartFallback(items) {
      localStorage.setItem('msa_cart', JSON.stringify(items));
    }
    function getCartItems() {
      if (window.MSACart?.getItems) return MSACart.getItems();
      return _readCartFallback();
    }
    function setQty(id, qty) {
      qty = Math.max(1, qty|0);
      if (window.MSACart?.setQty) { MSACart.setQty(id, qty); return; }
      const items = _readCartFallback().map(i => (i.id===id? {...i, qty}: i));
      _writeCartFallback(items);
    }
    function removeItem(id) {
      if (window.MSACart?.remove) { MSACart.remove(id); return; }
      const items = _readCartFallback().filter(i => i.id!==id);
      _writeCartFallback(items);
    }
    function clearCart() {
      if (window.MSACart?.clear) { MSACart.clear(); return; }
      _writeCartFallback([]);
    }

    // ---------- Randare coÈ™ ----------
    function money(n){ return (n||0).toFixed(2)+' RON'; }

    function renderCart(){
      const body = document.getElementById('cart-body');
      const items = getCartItems();
      if (!items.length){
        body.innerHTML = '<tr><td colspan="5">CoÈ™ul este gol.</td></tr>';
      } else {
        body.innerHTML = items.map(i => {
          const line = (i.price||0) * (i.qty||1);
          return `
            <tr data-id="${i.id}">
              <td><div style="display:flex; gap:10px; align-items:center">
                <img src="${i.image||''}" alt="${i.name||''}"/>
                <div>
                  <div style="font-weight:600">${i.name||''}</div>
                  ${i.variant?`<div class="muted">${i.variant}</div>`:''}
                </div>
              </div></td>
              <td>${money(i.price)}</td>
              <td>
                <div class="qty">
                  <button type="button" class="qminus">âˆ’</button>
                  <input type="number" class="qinput" min="1" value="${i.qty||1}">
                  <button type="button" class="qplus">+</button>
                </div>
              </td>
              <td><b>${money(line)}</b></td>
              <td><button class="remove" type="button" aria-label="È˜terge">âœ•</button></td>
            </tr>
          `;
        }).join('');
      }
      bindRowEvents();
      updateTotals();
      updateBadge();
    }

    function bindRowEvents(){
      document.querySelectorAll('#cart-body tr').forEach(tr=>{
        const id = tr.getAttribute('data-id');
        tr.querySelector('.qminus')?.addEventListener('click', ()=>{ 
          const inp = tr.querySelector('.qinput'); inp.value = Math.max(1, (parseInt(inp.value)||1)-1); 
          setQty(id, inp.value); renderCart();
        });
        tr.querySelector('.qplus')?.addEventListener('click', ()=>{ 
          const inp = tr.querySelector('.qinput'); inp.value = (parseInt(inp.value)||1)+1; 
          setQty(id, inp.value); renderCart();
        });
        tr.querySelector('.qinput')?.addEventListener('change', (e)=>{ 
          const v = Math.max(1, parseInt(e.target.value)||1); 
          setQty(id, v); renderCart();
        });
        tr.querySelector('.remove')?.addEventListener('click', ()=>{ removeItem(id); renderCart(); });
      });
    }

    function calcTotals(){
      const items = getCartItems();
      const subtotal = items.reduce((s,i)=> s + (i.price||0)*(i.qty||1), 0);
      // exemplu de reducere simplÄƒ: 0 (poÈ›i schimba dupÄƒ campanii)
      const reducere = 0;
      // livrarea: 0 peste 300, altfel "calculat" (Ã®l lÄƒsÄƒm 0 vizual)
      const livrare = subtotal >= 300 ? 0 : 0;
      const total = subtotal - reducere + livrare;
      return { subtotal, reducere, livrare, total };
    }

    function updateTotals(){
      const t = calcTotals();
      document.getElementById('t-sub').textContent   = money(t.subtotal);
      document.getElementById('t-disc').textContent  = money(t.reducere);
      document.getElementById('t-ship').textContent  = t.livrare===0 ? '0 RON' : 'calculat';
      document.getElementById('t-total').textContent = money(t.total);
    }

    function updateBadge(){
      const el = document.getElementById('cart-count');
      if (!el) return;
      if (window.MSACart?.updateCartCountBadge) { MSACart.updateCartCountBadge(); return; }
      const n = getCartItems().reduce((s,i)=>s+(i.qty||1),0);
      el.textContent = n;
    }

    // ---------- Trimitere comandÄƒ: anti-dublu & throttle ----------
    window.MSAOrder = (function(){
      let sending = false;
      const THROTTLE_MS = 60*1000; // 1 minut

      function recentlySent(){
        const t = Number(localStorage.getItem('msa_last_order_ts')||0);
        return Date.now() - t < THROTTLE_MS;
      }

      async function sendEmail(payload){
        if (sending) return {ok:false, reason:'already_sending'};
        if (recentlySent()) return {ok:false, reason:'throttled'};

        sending = true;
        try{
          // !!! completeazÄƒ cu ID-urile tale EmailJS:
          const serviceId  = 'YOUR_SERVICE_ID';
          const templateId = 'YOUR_TEMPLATE_ID';
          const res = await emailjs.send(serviceId, templateId, payload);
          localStorage.setItem('msa_last_order_ts', Date.now().toString());
          return {ok:true, res};
        }catch(err){
          return {ok:false, err};
        }finally{
          sending = false;
        }
      }

      return { sendEmail };
    })();

    // ---------- Bind formular ----------
    (function bindCheckoutOnce(){
      if (window.__MSA_CHECKOUT_BOUND__) return;
      window.__MSA_CHECKOUT_BOUND__ = true;

      document.getElementById('year').textContent = new Date().getFullYear();
      renderCart();

      const form = document.getElementById('checkout-form');
      const btn  = document.getElementById('btn-confirm');
      if (!form || !btn) return;

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (btn.disabled) return;

        const items = getCartItems();
        if (!items.length){ alert('CoÈ™ul este gol.'); return; }

        btn.disabled = true;
        const old = btn.textContent; btn.textContent = 'Se trimiteâ€¦';

        const data = new FormData(form);
        const totals = calcTotals();

        const orderId = Math.random().toString(36).slice(2,8).toUpperCase();
        const payload = {
          order_id: orderId,
          nume:       data.get('nume')||'',
          email:      data.get('email')||'',
          telefon:    data.get('telefon')||'',
          adresa:     data.get('adresa')||'',
          observatii: data.get('observatii')||'',
          items: items.map(i => `${i.name} x${i.qty||1} â€” ${i.price} RON`).join('\n'),
          subtotal: totals.subtotal.toFixed(2)+' RON',
          reducere: totals.reducere.toFixed(2)+' RON',
          livrare:  totals.livrare===0 ? '0 RON' : 'calculat',
          total:    totals.total.toFixed(2)+' RON',
        };

        const r = await MSAOrder.sendEmail(payload);

        if (r.ok){
          alert(`MulÈ›umim! Comanda #${orderId} a fost trimisÄƒ. Vei primi un e-mail de confirmare.`);
          clearCart();
          renderCart();
          updateTotals();
          form.reset();
          // location.href = 'multumesc.html'; // dacÄƒ vrei redirect
        } else if (r.reason === 'throttled'){
          alert('Comanda a fost deja trimisÄƒ foarte recent. VerificÄƒ e-mailul.');
        } else {
          console.error(r.err||r);
          alert('A apÄƒrut o eroare la trimitere. ReÃ®ncearcÄƒ.');
        }

        btn.textContent = old; btn.disabled = false;
      });
    })();
  </script>

  <!-- dacÄƒ ai deja cart.js separat, lasÄƒ-l Ã®ncÄƒrcat dupÄƒ cos.html sau Ã®naintea scriptului de mai sus -->
  <script src="cart.js"></script>
</body>
</html>
