<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CoÈ™ â€” MSA Handmade</title>

  <meta name="description" content="FinalizeazÄƒ comanda la MSA Handmade. CoÈ™ de cumpÄƒrÄƒturi cu reduceri automate È™i livrare gratuitÄƒ de la 300 RON." />
  <link rel="canonical" href="https://www.msahandmade.ro/cos.html" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* mici ajustÄƒri doar pentru pagina coÈ™ului */
    .totals{display:grid;gap:8px}
    .totals .row{display:flex;justify-content:space-between}
    .totals .big{border-top:2px solid #222;padding-top:10px;font-weight:800;font-size:1.15rem}
    .form-grid{display:grid;gap:12px}
    @media(min-width:720px){.form-grid{grid-template-columns:repeat(2,1fr)}}
    fieldset.firma{display:none}
    fieldset.firma.show{display:block}
    .muted{color:#777;font-size:.92rem}
    table.cart{width:100%;border-collapse:collapse;table-layout:fixed}
    table.cart th,table.cart td{padding:10px;border-bottom:1px solid #eee;vertical-align:middle}
    table.cart img{width:64px;height:64px;object-fit:cover;border-radius:8px}
    .qty{display:inline-flex;align-items:center;border:1px solid #ddd;border-radius:10px;background:#fff;overflow:hidden}
    .qty button{width:32px;height:32px;border:0;background:#f6f6f6;font-weight:800;font-size:18px}
    .qty input{width:44px;height:32px;border:0;text-align:center}
  </style>
</head>
<body>

  <div class="promo">Reduceri pÃ¢nÄƒ la <b>-20%</b> â€¢ Livrare gratuitÄƒ de la <b>300 RON</b></div>

  <header class="header">
    <nav id="main-nav">
      <a href="index.html">AcasÄƒ</a>
      <a href="produse.html">Produse</a>
      <a href="despre.html">Despre</a>
      <a href="contact.html">Contact</a>
      <a href="cos.html" class="cart-pill">ðŸ›’ <span id="cart-count">0</span></a>
    </nav>
  </header>

  <main class="wrap">
    <h1>CoÈ™ul tÄƒu</h1>

    <div class="box">
      <table class="cart">
        <thead>
          <tr>
            <th>Produs</th>
            <th>Detalii</th>
            <th>Cant.</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="cart-tbody">
          <!-- rÃ¢ndurile se populeazÄƒ din JS -->
        </tbody>
      </table>
    </div>

    <div class="grid" style="margin-top:16px">
      <!-- totaluri -->
      <section class="box">
        <h2 style="margin-top:0">Totaluri</h2>
        <div class="totals">
          <div class="row"><span>Subtotal</span><span id="subval">0 RON</span></div>
          <div class="row"><span>Reducere</span><span id="discval">0 RON</span></div>
          <div class="row"><span>Livrare</span><span id="shipval">0 RON</span></div>
          <div class="row big"><span>Total</span><span id="totval">0 RON</span></div>
        </div>
        <p class="muted" style="margin-top:10px">
          Reduceri automate: â‰¥200 RON âˆ’10%, â‰¥300 RON âˆ’15%, â‰¥400 RON âˆ’20%.<br>
          Livrare gratuitÄƒ de la 300 RON (chiar dacÄƒ se aplicÄƒ reducere).
        </p>
      </section>

      <!-- formular livrare -->
      <section class="box">
        <h2 style="margin-top:0">Detalii pentru livrare</h2>

        <form id="checkout-form">
          <div class="row" style="margin-bottom:10px">
            <label><input type="radio" name="tip" value="PF" checked> PersoanÄƒ fizicÄƒ</label>
            <label style="margin-left:12px"><input type="radio" name="tip" value="PJ"> PersoanÄƒ juridicÄƒ</label>
          </div>

          <div class="form-grid">
            <div class="row">
              <label>Nume</label>
              <input id="nume" required />
            </div>
            <div class="row">
              <label>Prenume</label>
              <input id="prenume" required />
            </div>
            <div class="row">
              <label>Email</label>
              <input id="email" type="email" required />
            </div>
            <div class="row">
              <label>Telefon</label>
              <input id="telefon" inputmode="tel" required />
            </div>
            <div class="row">
              <label>JudeÈ›</label>
              <input id="judet" required />
            </div>
            <div class="row">
              <label>OraÈ™</label>
              <input id="oras" required />
            </div>
            <div class="row">
              <label>Cod poÈ™tal</label>
              <input id="codpostal" inputmode="numeric" required />
            </div>
            <div class="row">
              <label>AdresÄƒ</label>
              <input id="adresa" required />
            </div>
          </div>

          <!-- cÃ¢mpuri firmÄƒ (PJ) -->
          <fieldset class="firma" id="firma-box" style="margin-top:12px">
            <legend>Date firmÄƒ (pentru PJ)</legend>
            <div class="form-grid">
              <div class="row">
                <label>Denumire firmÄƒ</label>
                <input id="firma" />
              </div>
              <div class="row">
                <label>CUI / CIF</label>
                <input id="cui" />
              </div>
              <div class="row">
                <label>Nr. Ã®nreg. comerÈ›</label>
                <input id="regcom" />
              </div>
              <div class="row">
                <label>IBAN (opÈ›ional)</label>
                <input id="iban" />
              </div>
            </div>
          </fieldset>

          <div class="row" style="margin-top:12px">
            <label>MenÈ›iuni (opÈ›ional)</label>
            <textarea id="mentiuni" rows="3" placeholder="Ex: prefer livrarea dupÄƒ ora 16:00"></textarea>
          </div>

          <div class="actions" style="margin-top:12px">
            <button type="submit" class="btn primary" id="place-order">Trimite comanda</button>
            <button type="button" class="btn ghost" id="clear-cart">GoleÈ™te coÈ™ul</button>
          </div>
        </form>
      </section>
    </div>
  </main>

  <footer>
    <small>&copy; <span id="year"></span> â€“ MSA Handmade. Toate drepturile rezervate.</small>
  </footer>

  <!-- librÄƒria coÈ™ului -->
  <script src="cart.js?v=10"></script>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- ===== EmailJS: configurare + trimitere comenzi ===== -->
  <script>
    (function(){ emailjs.init('isadfb7-TV_89l_6k'); })();

    const SERVICE_ID       = 'service_ix0zpp7';
    const TEMPLATE_ADMIN   = 'template_13qpqtt';  // comanda spre magazin
    const TEMPLATE_CLIENT  = 'template_9yctwor';  // confirmare spre client

    function buildProductsText(items){
      if(!items.length) return 'â€”';
      return items.map(it =>
        `${it.name} Ã— ${it.qty} â€” ${(Number(it.price)||0).toFixed(2)} RON`
      ).join('\\n');
    }

    function buildProformaHTML(items, totals){
      const rows = items.map(it => `
        <tr>
          <td style="padding:6px 8px;border-bottom:1px solid #eee">${it.name}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;text-align:center">${it.qty}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;text-align:right">${(Number(it.price)||0).toFixed(2)} RON</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;text-align:right">${((Number(it.price)||0)*(it.qty||1)).toFixed(2)} RON</td>
        </tr>
      `).join('');
      return `
        <h3 style="margin:0 0 8px">ProformÄƒ MSA Handmade</h3>
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th style="text-align:left;padding:6px 8px;border-bottom:2px solid #222">Produs</th>
              <th style="text-align:center;padding:6px 8px;border-bottom:2px solid #222">Cant.</th>
              <th style="text-align:right;padding:6px 8px;border-bottom:2px solid #222">PreÈ›</th>
              <th style="text-align:right;padding:6px 8px;border-bottom:2px solid #222">Total</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <div style="margin-top:10px">
          <div><b>Subtotal:</b> ${totals.subtotal.toFixed(2)} RON</div>
          <div><b>Reducere:</b> -${totals.reducere.toFixed(2)} RON</div>
          <div><b>Livrare:</b> ${totals.livrare.toFixed(2)} RON</div>
          <div style="font-size:1.1rem;margin-top:6px"><b>Total:</b> ${totals.total.toFixed(2)} RON</div>
        </div>
      `;
    }

    async function sendOrder(form){
      const items = MSACart.getCart();
      if(!items.length){ alert('CoÈ™ul este gol. AdaugÄƒ produse Ã®nainte de a trimite comanda.'); return; }

      const totals = MSACart.getTotals();
      const order_id = Date.now().toString().slice(-6);
      const produseTxt = buildProductsText(items);
      const htmlProforma = buildProformaHTML(items, totals);

      const tip = form.querySelector('input[name="tip"]:checked')?.value || 'PF';

      // date client comune
      const base = {
        tip,
        nume:      document.getElementById('nume').value.trim(),
        prenume:   document.getElementById('prenume').value.trim(),
        email:     document.getElementById('email').value.trim(),
        telefon:   document.getElementById('telefon').value.trim(),
        judet:     document.getElementById('judet').value.trim(),
        oras:      document.getElementById('oras').value.trim(),
        codpostal: document.getElementById('codpostal').value.trim(),
        adresa:    document.getElementById('adresa').value.trim(),
        mentiuni:  document.getElementById('mentiuni').value.trim()
      };

      // cÃ¢mpuri firmÄƒ (dacÄƒ e PJ)
      const firma = {
        firma:  document.getElementById('firma').value.trim(),
        cui:    document.getElementById('cui').value.trim(),
        regcom: document.getElementById('regcom').value.trim(),
        iban:   document.getElementById('iban').value.trim()
      };

      // cÄƒtre magazin (admin)
      const paramsAdmin = {
        ...base,
        ...(tip==='PJ' ? firma : {}),
        produse: produseTxt,
        subtotal: totals.subtotal.toFixed(2),
        livrare: totals.livrare.toFixed(2),
        total: totals.total.toFixed(2),
        order_id
      };

      // cÄƒtre client (confirmare)
      const paramsClient = {
        to_email: base.email,
        nume: base.nume,
        order_id,
        html_proforma: htmlProforma
      };

      try{
        await emailjs.send(SERVICE_ID, TEMPLATE_ADMIN,  paramsAdmin);
        await emailjs.send(SERVICE_ID, TEMPLATE_CLIENT, paramsClient);
        alert('âœ… Comanda a fost trimisÄƒ! Èši-am trimis confirmarea pe email.');
        MSACart.clear();
        window.location.href = 'multumesc.html';
      }catch(err){
        console.error('EmailJS error:', err);
        alert('A apÄƒrut o eroare la trimiterea emailului. Te rugÄƒm Ã®ncearcÄƒ din nou.');
      }
    }
  </script>

  <!-- ===== CoÈ™: randare tabel + acÈ›iuni ===== -->
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('year').textContent = new Date().getFullYear();

      const tbody  = document.getElementById('cart-tbody');
      const subEl  = document.getElementById('subval');
      const discEl = document.getElementById('discval');
      const shipEl = document.getElementById('shipval');
      const totEl  = document.getElementById('totval');

      function fmt(n){ return (Number(n)||0).toFixed(2) + ' RON'; }

      function render(){
        const items = MSACart.getCart();
        tbody.innerHTML = items.map(it=>`
          <tr data-id="${it.id}">
            <td>
              <div style="display:flex;gap:10px;align-items:center">
                <img src="${it.image||''}" alt="">
                <div><strong>${it.name||''}</strong><br><small>${fmt(it.price)}</small></div>
              </div>
            </td>
            <td>
              <div class="qty">
                <button class="qminus" aria-label="minus">âˆ’</button>
                <input type="number" min="1" value="${it.qty||1}">
                <button class="qplus" aria-label="plus">+</button>
              </div>
              <button class="rm btn ghost" style="margin-left:6px">È˜terge</button>
            </td>
            <td style="text-align:center">${it.qty||1}</td>
            <td style="text-align:right"><strong>${fmt((it.price||0)*(it.qty||1))}</strong></td>
          </tr>
        `).join('');

        const t = MSACart.getTotals();
        subEl.textContent  = fmt(t.subtotal);
        discEl.textContent = '- ' + fmt(t.reducere);
        shipEl.textContent = fmt(t.livrare);
        totEl.textContent  = fmt(t.total);

        bindRowEvents();
        MSACart.updateCartCountBadge();
      }

      function bindRowEvents(){
        tbody.querySelectorAll('tr').forEach(row=>{
          const id = row.dataset.id;
          row.querySelector('.qminus').addEventListener('click', ()=>{ MSACart.changeQty(id,-1); render(); });
          row.querySelector('.qplus').addEventListener('click', ()=>{ MSACart.changeQty(id, 1); render(); });
          row.querySelector('input').addEventListener('change', (e)=>{ MSACart.setQty(id, e.target.value); render(); });
          row.querySelector('.rm').addEventListener('click', ()=>{ MSACart.removeFromCart(id); render(); });
        });
      }

      // toggle PJ fields
      const firmaBox = document.getElementById('firma-box');
      document.querySelectorAll('input[name="tip"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          if(r.value==='PJ' && r.checked){ firmaBox.classList.add('show'); }
          if(r.value==='PF' && r.checked){ firmaBox.classList.remove('show'); }
        });
      });

      // butoane formular
      document.getElementById('clear-cart').addEventListener('click', ()=>{
        if(confirm('Sigur vrei sÄƒ goleÈ™ti coÈ™ul?')){ MSACart.clear(); render(); }
      });

      document.getElementById('checkout-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        sendOrder(e.target);   // trimite prin EmailJS
      });

      render();
    });
  </script>
</body>
</html>
