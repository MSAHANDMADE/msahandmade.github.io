<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CoÈ™ul tÄƒu â€” M.S.A Handmade Decor</title>
  <meta name="description" content="FinalizeazÄƒ comanda pe M.S.A Handmade Decor. Livrare gratuitÄƒ de la 300 RON È™i reduceri automate.">
  <link rel="stylesheet" href="styles.css" />
  <style>
    main.wrap{margin-top:16px}
    form .row{display:flex;gap:12px}
    @media (max-width:640px){ form .row{flex-direction:column} }
    .btn-primary{background:#0a2230;color:#fff;padding:12px 16px;border:0;border-radius:10px;cursor:pointer;font-weight:800}
    .btn-primary:hover{background:#0e344c}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="promo">Reduceri pÃ¢nÄƒ la <b>-20%</b> â€¢ Livrare gratuitÄƒ de la <b>300 RON</b></div>

  <header class="header">
    <nav id="main-nav">
      <a href="index.html">AcasÄƒ</a>
      <a href="produse.html">Produse</a>
      <a href="despre.html">Despre</a>
      <a href="contact.html">Contact</a>
      <a href="cos.html" class="cart-pill">ğŸ›’ <span id="cart-count">0</span></a>
    </nav>
  </header>

  <main class="wrap">
    <h1>CoÈ™ul tÄƒu</h1>
    <div id="cart-mount"></div>

    <h2 style="margin-top:22px">FinalizeazÄƒ comanda</h2>
    <form id="order-form" class="box">
      <div class="row">
        <div style="flex:1">
          <label>Tip client</label>
          <select id="tip">
            <option value="PersoanÄƒ fizicÄƒ" selected>PersoanÄƒ fizicÄƒ</option>
            <option value="PersoanÄƒ juridicÄƒ">PersoanÄƒ juridicÄƒ</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Nume</label>
          <input id="nume" required>
        </div>
        <div style="flex:1">
          <label>Prenume</label>
          <input id="prenume" required>
        </div>
      </div>

      <!-- CÃ¢mpuri PJ -->
      <div id="pj-fields" class="hidden">
        <div class="row">
          <div style="flex:1">
            <label>Denumire firmÄƒ</label>
            <input id="firma">
          </div>
          <div style="flex:1">
            <label>CUI</label>
            <input id="cui">
          </div>
          <div style="flex:1">
            <label>Nr. Reg. ComerÈ›</label>
            <input id="regcom">
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>IBAN (opÈ›ional)</label>
            <input id="iban">
          </div>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Email</label>
          <input id="email" type="email" required>
        </div>
        <div style="flex:1">
          <label>Telefon</label>
          <input id="telefon" required>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>JudeÈ›</label>
          <input id="judet" required>
        </div>
        <div style="flex:1">
          <label>OraÈ™</label>
          <input id="oras" required>
        </div>
        <div style="flex:1">
          <label>Cod poÈ™tal</label>
          <input id="codpostal" required>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>AdresÄƒ</label>
          <input id="adresa" required>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>MenÈ›iuni (opÈ›ional)</label>
          <textarea id="mentiuni" rows="3"></textarea>
        </div>
      </div>

      <button class="btn btn-primary" type="submit">Trimite comanda</button>
    </form>
  </main>

  <footer class="footer" style="text-align:center;padding:24px 10px;color:#666">
    <small>&copy; <span id="year"></span> â€” M.S.A Handmade Decor</small>
  </footer>

  <!-- CoÈ™ + EmailJS -->
  <script src="cart.js?v=9"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    // === EmailJS === (ID-urile tale reale)
    const SERVICE_ID      = 'service_ix0zpp7';
    const PUBLIC_KEY      = 'iSadfb7-TV_89l_6k';
    const TEMPLATE_ADMIN  = 'template_13qpqtt'; // â€Contact Usâ€ â€“ cÄƒtre magazin
    const TEMPLATE_CLIENT = 'template_9yctwor'; // â€Order Confirmationâ€ â€“ cÄƒtre client
    emailjs.init(PUBLIC_KEY);

    document.getElementById('year').textContent = new Date().getFullYear();

    document.addEventListener('DOMContentLoaded', () => {
      MSACart.renderCart();
      MSACart.updateCartCountBadge();
    });

    // AfiÈ™eazÄƒ cÃ¢mpurile PJ
    const tipSel = document.getElementById('tip');
    const pjBox  = document.getElementById('pj-fields');
    function togglePJ(){
      pjBox.classList.toggle('hidden', tipSel.value !== 'PersoanÄƒ juridicÄƒ');
      // cÃ¢nd e PJ, facem cÃ¢mpurile obligatorii
      const required = tipSel.value === 'PersoanÄƒ juridicÄƒ';
      ['firma','cui','regcom'].forEach(id=>{
        const el = document.getElementById(id);
        el.required = required;
      });
    }
    tipSel.addEventListener('change', togglePJ);
    togglePJ();

    function money(v){ return MSACart.money(v); }

    // Trimite comanda
    document.getElementById('order-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const cart = MSACart.getCart();
      if (!cart.length){ alert('CoÈ™ul este gol.'); return; }

      const totals = MSACart._calcTotals(cart);

      // form values
      const form = {
        tip: tipSel.value,
        nume: nume.value.trim(),
        prenume: prenume.value.trim(),
        email: email.value.trim(),
        telefon: telefon.value.trim(),
        judet: judet.value.trim(),
        oras: oras.value.trim(),
        codpostal: codpostal.value.trim(),
        adresa: adresa.value.trim(),
        mentiuni: mentiuni.value.trim(),
        // PJ
        firma: (document.getElementById('firma').value || '').trim(),
        cui: (document.getElementById('cui').value || '').trim(),
        regcom: (document.getElementById('regcom').value || '').trim(),
        iban: (document.getElementById('iban').value || '').trim(),
        order_id: Date.now().toString().slice(-6)
      };

      // produse Ã®n text (pentru emailul cÄƒtre magazin)
      const produseText = cart.map(p => `â€¢ ${p.name} Ã— ${p.qty} â€” ${money(p.price*p.qty)} RON`).join('\n');

      // Parametrii pentru È™ablonul â€Contact Usâ€ (cÄƒtre magazin)
      const paramsAdmin = {
        tip: form.tip,
        nume: form.nume,
        prenume: form.prenume,
        email: form.email,
        telefon: form.telefon,
        judet: form.judet,
        oras: form.oras,
        codpostal: form.codpostal,
        adresa: form.adresa,
        mentiuni: form.mentiuni || '-',
        produse: produseText,
        subtotal: money(totals.subtotal),
        livrare: money(totals.shipping),
        total: money(totals.total),
        order_id: form.order_id,
        // extra pentru PJ (dacÄƒ nu existÄƒ Ã®n template, sunt ignorate)
        firma: form.firma,
        cui: form.cui,
        regcom: form.regcom,
        iban: form.iban
      };

      // HTML frumos pentru client â€” Ã®ncÄƒrcat din proforma.html
      const htmlProforma = await MSACart.buildProformaHTML(cart, totals, form);

      // Parametrii pentru â€Order Confirmationâ€ (cÄƒtre client)
      const paramsClient = {
        to_email: form.email,     // EXACT cum e Ã®n template-ul tÄƒu
        nume: form.nume,
        order_id: form.order_id,
        html_proforma: htmlProforma
      };

      try {
        // 1) email spre magazin
        await emailjs.send(SERVICE_ID, TEMPLATE_ADMIN, paramsAdmin);

        // 2) confirmare spre client
        await emailjs.send(SERVICE_ID, TEMPLATE_CLIENT, paramsClient);

        alert('âœ… Comanda a fost trimisÄƒ! Èši-am trimis confirmarea prin email.');
        MSACart.clear();
        window.location.href = 'multumesc.html';
      } catch (err) {
        console.error('EmailJS error:', err);
        alert('A apÄƒrut o eroare la trimiterea emailului. VerificÄƒ ID-urile È™i starea EmailJS.');
      }
    });
  </script>
</body>
</html>
